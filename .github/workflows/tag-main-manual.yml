name: Tag Main (Manual)

on:
  workflow_dispatch:
    inputs:
      tag_name:
        description: "Tag to create/update (example: v1.1.2 or v1)"
        required: true
        type: string
      force_update:
        description: "Force-update tag if it already exists"
        required: false
        default: false
        type: boolean

permissions:
  contents: write

jobs:
  tag-main:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Configure push auth token
        env:
          TAG_PUSH_TOKEN: ${{ secrets.TAG_PUSH_TOKEN }}
        run: |
          set -euo pipefail

          if [[ -z "${TAG_PUSH_TOKEN:-}" ]]; then
            echo "Missing TAG_PUSH_TOKEN secret."
            echo "Create a classic PAT with 'repo' and 'workflow' scopes and store it as TAG_PUSH_TOKEN."
            exit 1
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git remote set-url origin "https://x-access-token:${TAG_PUSH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"

      - name: Validate and create tag at latest main
        env:
          TAG_NAME: ${{ inputs.tag_name }}
          FORCE_UPDATE: ${{ inputs.force_update }}
        run: |
          set -euo pipefail

          if ! [[ "${TAG_NAME}" =~ ^v[0-9A-Za-z._-]+$ ]]; then
            echo "Invalid tag '${TAG_NAME}'. Use a safe tag like v1, v1.2.3, v1.2.3-rc1."
            exit 1
          fi

          git fetch --force --tags origin
          git fetch origin main

          target_sha="$(git rev-parse origin/main)"
          echo "Target SHA (origin/main): ${target_sha}"

          if git rev-parse -q --verify "refs/tags/${TAG_NAME}" >/dev/null; then
            if [[ "${FORCE_UPDATE}" != "true" ]]; then
              echo "Tag ${TAG_NAME} already exists. Re-run with force_update=true to move it."
              exit 1
            fi

            echo "Force-updating existing tag ${TAG_NAME} to ${target_sha}"
            git tag -f "${TAG_NAME}" "${target_sha}"
            git push origin "refs/tags/${TAG_NAME}" --force
            exit 0
          fi

          echo "Creating tag ${TAG_NAME} at ${target_sha}"
          git tag -a "${TAG_NAME}" "${target_sha}" -m "Manual tag ${TAG_NAME} at origin/main (${target_sha})"
          git push origin "refs/tags/${TAG_NAME}"
