name: Update Release Aliases

on:
  release:
    types: [published]
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Stable semver tag to process (example: v1.2.3)"
        required: true
        type: string

permissions:
  contents: write

jobs:
  update-aliases:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Configure push auth token
        env:
          TAG_PUSH_TOKEN: ${{ secrets.TAG_PUSH_TOKEN }}
        run: |
          set -euo pipefail

          if [[ -z "${TAG_PUSH_TOKEN:-}" ]]; then
            echo "Missing TAG_PUSH_TOKEN secret."
            echo "Create a classic PAT with 'repo' and 'workflow' scopes and store it as TAG_PUSH_TOKEN."
            exit 1
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git remote set-url origin "https://x-access-token:${TAG_PUSH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"

      - name: Move major and latest aliases for stable releases
        env:
          RELEASE_TAG: ${{ inputs.release_tag || github.event.release.tag_name || github.ref_name }}
        run: |
          set -euo pipefail

          if ! [[ "${RELEASE_TAG:-}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Tag ${RELEASE_TAG} is not a stable semver release. Skipping aliases."
            exit 0
          fi

          git fetch --force --tags origin

          major_alias="$(printf '%s' "${RELEASE_TAG}" | cut -d. -f1)"
          major_number="${major_alias#v}"

          major_latest_tag="$(
            git tag --list "v${major_number}.*" \
              | grep -E "^v${major_number}\.[0-9]+\.[0-9]+$" \
              | sort -V \
              | tail -n1 || true
          )"

          if [[ -z "${major_latest_tag}" ]]; then
            echo "Could not resolve latest stable tag for major ${major_alias}."
            exit 1
          fi

          major_target_sha="$(git rev-list -n 1 "${major_latest_tag}")"
          if [[ -z "${major_target_sha}" ]]; then
            echo "Could not resolve commit for ${major_latest_tag}."
            exit 1
          fi

          latest_stable_tag="$(
            git tag --list 'v*' \
              | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' \
              | sort -V \
              | tail -n1 || true
          )"
          if [[ -z "${latest_stable_tag}" ]]; then
            echo "Could not resolve latest stable semver tag."
            exit 1
          fi

          latest_target_sha="$(git rev-list -n 1 "${latest_stable_tag}")"
          if [[ -z "${latest_target_sha}" ]]; then
            echo "Could not resolve commit for ${latest_stable_tag}."
            exit 1
          fi

          echo "Updating ${major_alias} -> ${major_latest_tag} (${major_target_sha})"
          echo "Updating latest -> ${latest_stable_tag} (${latest_target_sha})"

          current_major_sha="$(git rev-parse -q --verify "refs/tags/${major_alias}^{commit}" || true)"
          current_latest_sha="$(git rev-parse -q --verify "refs/tags/latest^{commit}" || true)"

          if [[ "${current_major_sha}" != "${major_target_sha}" ]]; then
            git tag -f "${major_alias}" "${major_target_sha}"
            git push origin "refs/tags/${major_alias}" --force
          else
            echo "${major_alias} already points to ${major_target_sha}; no update needed."
          fi

          if [[ "${current_latest_sha}" != "${latest_target_sha}" ]]; then
            git tag -f latest "${latest_target_sha}"
            git push origin refs/tags/latest --force
          else
            echo "latest already points to ${latest_target_sha}; no update needed."
          fi
