name: Postgres Preview Branch (Internal)

on:
  pull_request:
    types: [opened, reopened, synchronize, closed]

permissions:
  contents: read

concurrency:
  group: preview-db-${{ github.repository }}-${{ github.event.number }}-${{ vars.BASE_DB }}
  cancel-in-progress: false

jobs:
  create-preview-branch-db:
    if: github.event.action != 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create Preview Branch DB (idempotent)
        uses: ./
        with:
          mode: create
          base_db: ${{ vars.BASE_DB }}
          pr_number: ${{ github.event.number }}
          source_db: ${{ vars.SOURCE_DB || vars.BASE_DB }}
          app_db_user: ${{ vars.APP_DB_USER }}
          pg_host: ${{ secrets.PGHOST }}
          pg_port: ${{ secrets.PGPORT }}
          pg_user: ${{ secrets.PGUSER }}
          pg_password: ${{ secrets.PGPASSWORD }}
          pg_database: ${{ vars.PGDATABASE || 'postgres' }}

  drop-preview-branch-db:
    if: github.event.action == 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Drop Preview Branch DB
        uses: ./
        with:
          mode: drop
          base_db: ${{ vars.BASE_DB }}
          pr_number: ${{ github.event.number }}
          source_db: ${{ vars.SOURCE_DB || vars.BASE_DB }}
          pg_host: ${{ secrets.PGHOST }}
          pg_port: ${{ secrets.PGPORT }}
          pg_user: ${{ secrets.PGUSER }}
          pg_password: ${{ secrets.PGPASSWORD }}
          pg_database: ${{ vars.PGDATABASE || 'postgres' }}
